<!DOCTYPE html>
<html>
    <head>
        <title> è§£æå®éªŒ </title>
        <meta name="referrer" content="no-referrer">

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />

        <script src="/public/js/jquery-3.6.0.min.js"></script>
        <script src="/public/js/axios.min.js"></script>
        <script src="/public/js/echarts.min.js"></script>

        <script src="/public/js/sidebar.js"></script>
        <script src="/public/js/parse_history.js"></script>

        <link rel="stylesheet" href="/public/css/common.css">
        <link rel="stylesheet" href="/public/css/modal.css">
        <link rel="stylesheet" href="/public/css/sidebar.css">
        <link rel="stylesheet" href="/public/css/parse_test.css">
    </head>
<body>
    <div id="app"/>

<script>
    let RuleStageEnum = {
        Testing: 0,
        Production: 1,
    }
    let RuleKeyToRead = {
        'name': 'ç«™ç‚¹',
        'bodies': 'æ­£æ–‡',
        'noises': 'å™ªå£°',
        'author': 'ä½œè€…',
        'title': 'æ ‡é¢˜',
        'pub_time': 'å‘å¸ƒæ—¶é—´',
        'create_time': 'åˆ›å»ºäº',
        'update_time': 'ä¿®æ”¹äº',
    }



    function createLoadingContainer(){
        let loadingContainer = $('<div>')
            .addClass('loading-container')
            .addClass('hide')
            .append(
                $('<div>').addClass('loading-spinner')
            )
        return loadingContainer
    }
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoadingStatus(loadingContainer) {
        loadingContainer.removeClass('hide');
    }

    // éšè—åŠ è½½çŠ¶æ€
    function hideLoadingStatus(loadingContainer) {
        loadingContainer.addClass('hide');
    }

    function getFaviconUrl(url){
        try {
            let domain = new URL(url).hostname
            return 'http://' + domain + '/favicon.ico'
        } catch (e) {
            console.log(e)
            return ''
        }
    }

    // æç¤ºä¿¡æ¯
    function showToast(message) {
        let $toast = $('<div class="toast">').text(message);
        $('body').append($toast);
        setTimeout(() => $toast.remove(), 2000);
    }
    function fallbackCopy(text) {
        const $temp = $('<textarea>');
        $temp.val(text).css({
            position: 'absolute',
            left: '-9999px'
        }).appendTo('body');

        $temp[0].select();
        $temp[0].setSelectionRange(0, 999999999); // å…¼å®¹ç§»åŠ¨ç«¯

        const success = document.execCommand('copy');
        $temp.remove();

        if (success) {
            showToast("å¤åˆ¶æˆåŠŸ")
        } else {
            showToast("å¤åˆ¶å¤±è´¥")
        }
    }

    $(document).ready(function () {
        let $loadingContainer = createLoadingContainer()

        let $app = $('#app');
        let $modal = $('<div id="ruleModal">');
        let $sidebar = generateNav('è§£æå®éªŒ')
        let $mainContent = $(`
        <div style="display: flex; flex-direction: row">
            <div id="sidebar"></div>
            <div id="app-content">
                <div class="history-list-container">
                </div>
                <div class="parse-test-container">
                    <div class="search-area">
                        <input type="text" id="url-input" placeholder="è¯·è¾“å…¥URL" class="search-input">

                        <!-- æ–°å¢è§„åˆ™ç»„æ ‡ç­¾å’Œé€‰æ‹©å™¨ -->
                        <div class="rule-group">
                            <span class="rule-label">è§„åˆ™ç»„ï¼š</span>
                            <select class="rule-selector" id="rule-select">
                                <option value="0" selected>ä»…æ­£å¼</option>
                                <option value="1">ä»…æµ‹è¯•</option>
                                <option value="2">æ­£å¼ä¼˜å…ˆ</option>
                                <option value="3">æµ‹è¯•ä¼˜å…ˆ</option>
                            </select>
                        </div>

                        <div class="search-button" >è§£æ</div>
                    </div>
                    <div class="search-result-container">
                    </div>
                </div>
            </div>
        </div>`)

        $mainContent.find('#sidebar').append($sidebar)
        $app.append($mainContent, $loadingContainer, $modal)

        function initHistoryList(){
            let historyList = GetHistoryList()
            let $historyListContainer = $mainContent.find('.history-list-container')
            $historyListContainer.empty()
            historyList.forEach((history) => {
                let $historyItem = $(`
                    <div class="history-item ${history.worthless ? 'worthless': ''}" style="background-image: url(${getFaviconUrl(history.url)}); background-repeat: no-repeat; background-size: 20px;">
                        <div class="history-item-title">
                            <div class="history-item-title-text">
                                ${history.title}
                            </div>
                            <div class="history-item-control-area">
                                <div class="history-item-title-time">
                                    ${history.time}
                                </div>
                                <div class="history-item-title-buttons">
                                    <button class="history-item-button">è¯¦æƒ…</button>
                                    <button class="history-item-button">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                        <div class="history-item-detail">
                            <div class="history-item-detail-row">
                                <div class="history-item-detail-label">é“¾æ¥</div>
                                <div class="history-item-detail-value">${history.url}</div>
                            </div>
                            <div class="history-item-detail-row">
                                <div class="history-item-detail-label">ä½œè€…</div>
                                <div class="history-item-detail-value">${history.author}</div>
                            </div>
                            <div class="history-item-detail-row">
                                <div class="history-item-detail-label">å‘å¸ƒæ—¶é—´</div>
                                <div class="history-item-detail-value">${history.publishTime}</div>
                            </div>
                        </div>
                    </div>
                    `
                )
                let $itemContainer = $historyItem.find('.history-item')
                let $titleContainer = $historyItem.find('.history-item-title')
                let $detailButton = $historyItem.find('.history-item-button').eq(0)
                let $deleteButton = $historyItem.find('.history-item-button').eq(1)
                let $historyDetail = $historyItem.find('.history-item-detail')
                // if (history.worthless){
                //     $itemContainer.addClass('worthless')
                // }

                $titleContainer.on('click', function (){
                    let $input = $mainContent.find('.search-input')
                    $input.val(history.url)
                    $input.focus()
                })
                $detailButton.on('click', function(event) {
                    event.stopPropagation()
                    $historyDetail.toggleClass('active')
                })
                $deleteButton.on('click', function(event) {
                    event.stopPropagation()
                    $historyItem.addClass('removing');
                    setTimeout(()=>{
                        RemoveHistoryByUrl(history.url)
                        $historyItem.remove();
                    }, 300)
                })
                $historyListContainer.append($historyItem)
            })
        }

        function showBaseParseMeta(baseParseResp, $parent){
            $parent.empty()
            let keys = [
                {'field': 'title', 'text': 'æ ‡é¢˜'},
                {'field': 'author', 'text': 'ä½œè€…'},
                {'field': 'pub_time', 'text': 'å‘å¸ƒæ—¶é—´'},
                {'field': 'content_source', 'text': 'æ¥æº'},
                {'field': 'worthless', 'text': 'æ˜¯å¦æ— æ„ä¹‰'},
                {'field': 'worth_type', 'text': 'ä»·å€¼ç±»å‹'},
            ]
            let $container = $('<div class="meta-container">')
            for (let key of keys){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">${key.text}</div>
                        <div class="meta-value">${baseParseResp[key.field]}</div>
                    </div>
                `))
            }
            if (baseParseResp.surface_image){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">å°é¢å›¾</div>
                        <div class="meta-value">
                            <img src="${baseParseResp.surface_image}" style="max-height: 100px"/>
                        </div>
                    </div>
                `))
            }
            let author_meta = baseParseResp.author_meta
            if (author_meta){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">ä½œè€…å…ƒä¿¡æ¯</div>
                        <div class="meta-value">
                            <div class="meta-row">
                                <div class="meta-label">å¤´åƒ</div>
                                <div class="meta-value">
                                    <img src="${author_meta.profile_url}" style="max-height: 50px"/>
                                </div>
                            </div>
                            <div class="meta-row">
                                <div class="meta-label">å</div>
                                <div class="meta-value">${author_meta.name}</div>
                            </div>
                            <div class="meta-row">
                                <div class="meta-label">æè¿°</div>
                                <div class="meta-value">${author_meta.description}</div>
                            </div>
                            <div class="meta-row">
                                <div class="meta-label">uid</div>
                                <div class="meta-value">${author_meta.uid}</div>
                            </div>
                        </div>
                    </div>
                `))
            }
            if (baseParseResp.oss_info){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">è§£æè¯¦æƒ…</div>
                        <div class="meta-value">
                            <a href="${baseParseResp.oss_info.url}" target="_blank">ç‚¹å‡»ä¸‹è½½</a>
                        </div>
                    </div>
                `))
            }
            if (baseParseResp.site_icon){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">ç«™ç‚¹å›¾æ ‡</div>
                        <div class="meta-value">
                            <img src="${baseParseResp.site_icon}" style="max-height: 50px"/>
                        </div>
                    </div>
                `))
            }
            if (baseParseResp.description){
                $container.append($(`
                    <div class="meta-row">
                        <div class="meta-label">é¡µé¢æè¿°</div>
                        <div class="meta-value">${baseParseResp.description}</div>
                    </div>
                `))
            }
            $parent.append($container)
        }
        function showBaseParseCrawl(baseParseResp, $parent){
            $parent.empty()
            let $readableContainer = $('<div class="readable-container">')

            let srcdoc = baseParseResp.raw_html || ''

            // åˆ›å»º iframe
            let $iframe = $(`<iframe>`, {
                // sandbox: baseParseResp['url'].indexOf('mp.weixin.qq.com') == -1 ? 'true' : 'false',
                class: 'reader-iframe',
                srcdoc: srcdoc,
                width: '100%',
                height: '100%',
            })
            if (baseParseResp['url'].indexOf('mp.weixin.qq.com') == -1) {
                // éå¾®ä¿¡æ–‡ç« 
                $iframe.attr('sandbox', 'allow-same-origin');
            }

            // å¤„ç†ç©ºå†…å®¹æƒ…å†µ
            if (!baseParseResp.raw_html) {
                $parent.addClass('reader-empty')
                    .html('<div>æ— å¯ç”¨ç½‘é¡µå†…å®¹</div>');
                return;
            }

            // å®‰å…¨é™åˆ¶ï¼ˆå¯é€‰ï¼‰
            // if (needSecurityRestriction()) { // éœ€è¦å®ç°æ£€æµ‹é€»è¾‘
            //     $iframe.addClass('reader-iframe--restricted')
            //         .attr('sandbox', 'allow-same-origin');
            // }

            $readableContainer.append($iframe);
            $parent.append($readableContainer);
        }

        function showBaseReadableHtml(baseParseResp, $parent){
            $parent.empty()
            let $readableContainer = $('<div class="readable-container">')

            // æ·»åŠ åŠ è½½çŠ¶æ€
            // let $loader = $('<div class="reader-loading">åŠ è½½é˜…è¯»å™¨å†…å®¹ä¸­...</div>');
            // $parent.append($loader);

            let srcdoc = baseParseResp.readable_html || ''
            srcdoc += `
            <style>
body {
    -webkit-font-smoothing: antialiased;
    font-family: -apple-system, "PingFang SC", "BlinkMacSystemFont", "Helvetica Neue", "Microsoft Yahei", Arial, "Segoe UI", "Hiragino Sans GB", "Heiti SC", "sans-serif", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    font-size: 1rem !important;
    line-height: 1.7;
    font-weight: 400;
    color: #2d2d2d;
    background-color: transparent;
    padding-bottom: 20px;
    word-spacing: 0.5px;
    width: 90%;
    margin: auto;
    margin-top: 15px;
}

img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-top: 34px;
}
deeplang-intro, [data-deeplang-intro] {
    display: block;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    background: rgba(234, 234, 234, .8);
}
h1, [data-deeplang-h1] {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.6;
    color: #1a1a1a;
    font-style: normal;
}
h2, [data-deeplang-h2] {
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.6;
    color: #1a1a1a;
    font-style: normal;
}
h3, [data-deeplang-h3] {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.6;
    color: #1a1a1a;
    font-style: normal;
}
h4, [data-deeplang-h4] {
    font-size: 0.875rem;
    font-weight: 600;
    line-height: 1.6;
    color: #1a1a1a;
    font-style: normal;
}
deeplang-legend, [data-deeplang-legend], legend {
    font-size: 16px;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 10;
    line-clamp: 10;
    -webkit-box-orient: vertical;
    line-height: 32px;
    text-align: justify;
    color: #7A7B7B;
}
deeplang-reference, [data-deeplang-reference] {
    font-weight: 400;
    color: #7A7B7B;
    font-size: 1.125rem;
}
pre code{
    display: block;
    overflow-x: auto;
    padding: 1em;
    background: antiquewhite;
    border-radius: 10px;
}

blockquote {
    margin-left: 0;
    padding-left: 20px;
    border-left: 2px solid #d9d9d9;
    font-size: 1.125rem;
}

            </style>
            `
            // åˆ›å»º iframe
            let $iframe = $('<iframe>', {
                class: 'reader-iframe',
                srcdoc: srcdoc,
                width: '100%',
                height: '100%',
            })

            // å¤„ç†ç©ºå†…å®¹æƒ…å†µ
            if (!baseParseResp.readable_html) {
                $parent.addClass('reader-empty')
                    .html('<div>æ— å¯ç”¨ç½‘é¡µå†…å®¹</div>');
                return;
            }

            // å®‰å…¨é™åˆ¶ï¼ˆå¯é€‰ï¼‰
            // if (needSecurityRestriction()) { // éœ€è¦å®ç°æ£€æµ‹é€»è¾‘
            //     $iframe.addClass('reader-iframe--restricted')
            //         .attr('sandbox', 'allow-same-origin');
            // }

            $readableContainer.append($iframe);
            $parent.append($readableContainer);
        }
        function showBaseTextParse(baseParseResp, $parent) {
            $parent.empty();

            // è§£ææ•°æ®
            let textparseResp = JSON.parse(baseParseResp.model_result_str);
            let infos = textparseResp.infos;

            // åˆ›å»ºå®¹å™¨
            let $container = $('<div class="textparse-container">');
            let $header = $('<div class="header">');
            let $filters = $('<div class="filters">');
            let $results = $('<div class="results">');

            // åˆå§‹åŒ–çŠ¶æ€
            let selectedLabels = [];
            let allLabels = [...new Set(infos.map(item => item.label))];
            allLabels = allLabels.sort((a, b) => a.localeCompare(b));

            // åˆ›å»ºå¸¦æ“ä½œçš„ç­›é€‰åŒºå—
            let $labelFilter = createFilterWithControls('label', 'é˜…è¯»å™¨æ ‡ç­¾ç­›é€‰', allLabels);

            // å¤åˆ¶æŒ‰é’®
            let $copyButton = $('<button class="copy-btn">ğŸ“‹ å¤åˆ¶å®Œæ•´æ•°æ®</button>')
                .on('click', () => {
                    if (navigator.clipboard){
                        navigator.clipboard.writeText(baseParseResp.model_result_str)
                            .then(() => showToast('å¤åˆ¶æˆåŠŸ'))
                            .catch(() => showToast('å¤åˆ¶å¤±è´¥'));
                    } else{
                        fallbackCopy(baseParseResp.model_result_str);
                    }
                });

            // æ¸²æŸ“é€»è¾‘
            function renderResults() {
                $results.empty();

                let filteredInfos = infos.filter(item => {
                    let matchLabel = selectedLabels.length === 0 || selectedLabels.includes(item.label);
                    return matchLabel;
                });

                filteredInfos.forEach(info => {
                    $results.append(createResultItem(info));
                });

                // ç©ºçŠ¶æ€å¤„ç†
                if (filteredInfos.length === 0) {
                    $results.html('<div class="empty-state">ğŸ•³ï¸ æ²¡æœ‰åŒ¹é…çš„ç»“æœ</div>');
                }
            }

            // åˆ›å»ºå¸¦æ§ä»¶çš„ç­›é€‰åŒºå—
            function createFilterWithControls(type, title, options) {
                let $section = $('<div class="filter-section">');
                let $header = $('<div class="filter-header">')
                    .append($('<span class="filter-title">').text(title));

                // æ“ä½œæŒ‰é’®
                let $controls = $('<div class="filter-controls">')
                    .append(
                        $('<button class="control-btn select-all">å…¨é€‰</button>')
                            .on('click', () => updateSelection(type, true)),
                        $('<button class="control-btn clear-all">æ¸…ç©º</button>')
                            .on('click', () => updateSelection(type, false))
                    );

                // æ ‡ç­¾å®¹å™¨
                let $tags = $('<div class="tag-container">');
                options.forEach(option => {
                    $tags.append(createTag(type, option));
                });

                return $section.append(
                    $header.append($controls),
                    $tags
                );
            }

            // æ›´æ–°é€‰æ‹©çŠ¶æ€
            function updateSelection(type, isSelectAll) {
                selectedLabels = isSelectAll ? allLabels : [];

                $(`.tag[data-type="${type}"]`)
                    .toggleClass('selected', isSelectAll)
                    .each(function() {
                        let tagValue = $(this).text();
                        let shouldSelect = isSelectAll ? allLabels.includes(tagValue) : false;
                        $(this).toggleClass('selected', shouldSelect);
                    });

                renderResults();
            }

            // åˆ›å»ºå•ä¸ªæ ‡ç­¾
            function createTag(type, value) {
                return $('<div class="tag">')
                    .text(value)
                    .attr('data-type', type)
                    .toggleClass('selected', selectedLabels.includes(value))
                    .on('click', function() {
                        let $tag = $(this);
                        let tagValue = $tag.text();

                        selectedLabels = selectedLabels.includes(tagValue)
                            ? selectedLabels.filter(t => t !== tagValue)
                            : [...selectedLabels, tagValue];

                        $tag.toggleClass('selected');
                        renderResults();
                    });
            }

            // ç»„è£…ç•Œé¢
            $header.append(
                $('<h2>').text(`åˆ‡å¥æ•°é‡ï¼š${infos.length}`),
                $copyButton,
            );
            $filters.append($labelFilter);
            $container.append($header, $filters, $results);
            $parent.append($container);
            renderResults();

            // åˆ›å»ºç»“æœé¡¹
            function createResultItem(info) {
                return $('<div class="result-item">')
                    .append(
                        $('<div class="content">').append(
                            $('<div class="txt">').text(info.txt),
                            $('<div class="meta">').html(`
                        <span class="label-tag">${info.label}</span>
                    `)
                        )
                    );
            }

        }
        function showBaseImages(baseParseResp, $parent) {
            $parent.empty();

            // ç©ºçŠ¶æ€å¤„ç†
            if (!baseParseResp?.images?.length) {
                $parent.html('<div class="empty-state">æš‚æ— å›¾ç‰‡</div>');
                return;
            }

            // åˆ›å»ºç”»å»Šå®¹å™¨
            let $galleryContainer = $('<div class="gallery-container">');
            let $imageList = $('<div class="image-list">');

            // éå†å›¾ç‰‡URL
            baseParseResp.images.forEach((url, index) => {
                let $imageItem = $('<div class="image-item">')
                    .append(
                        $('<img>')
                            .attr('src', url)
                            .attr('alt', `å›¾ç‰‡ ${index + 1}`)
                            .on('click', () => openLightbox(url, baseParseResp.images))
                    );

                $imageList.append($imageItem);
            });

            $galleryContainer.append($imageList);
            $parent.append($galleryContainer);
        }

        function showBaseParseTextContent(baseParseResp, $parent) {
            $parent.empty();

            // ç©ºçŠ¶æ€å¤„ç†
            if (!baseParseResp?.text?.length) {
                $parent.html('<div class="empty-state">ğŸ“­ æš‚æ— æ–‡æœ¬å†…å®¹</div>');
                return;
            }

            // åˆ›å»ºæ–‡æœ¬å®¹å™¨
            const $container = $('<div class="text-content-wrapper">');
            const $textContent = $('<pre class="text-content-container">').text(baseParseResp.text);

            // æ·»åŠ å¤åˆ¶æŒ‰é’®
            let $copyButton = $('<button class="copy-btn">ğŸ“‹ å¤åˆ¶å®Œæ•´æ•°æ®</button>')
                .on('click', () => {
                    if (navigator.clipboard){
                        navigator.clipboard.writeText(baseParseResp.text)
                            .then(() => showToast('å¤åˆ¶æˆåŠŸ'))
                            .catch(() => showToast('å¤åˆ¶å¤±è´¥'));
                    } else{
                        fallbackCopy(baseParseResp.text);
                    }
                });

            let $header = $('<div>').addClass('header')
            $header.append(
                $('<h2>').text(`æ€»å­—æ•°ï¼š${baseParseResp.text.length}`),
                $copyButton,
            )

            $container.append($header, $textContent);
            $parent.append($container);
        }

        // æ‰“å¼€å¤§å›¾é¢„è§ˆ
        function openLightbox(url, images) {
            let currentIndex = images.indexOf(url);

            let $lightbox = $('<div class="lightbox">')
                .append(
                    $('<div class="lightbox-content">')
                        .append(
                            $('<img>')
                                .attr('src', url)
                                .addClass('lightbox-image')
                        ),
                    $('<button class="lightbox-close">&times;</button>')
                        .on('click', () => $lightbox.remove()),
                    $('<button class="lightbox-nav lightbox-prev">&lt;</button>')
                        .on('click', () => {
                            currentIndex = (currentIndex - 1) % images.length;
                            navigateLightbox(currentIndex, images)
                        }),
                    $('<button class="lightbox-nav lightbox-next">&gt;</button>')
                        .on('click', () => {
                            currentIndex = (currentIndex + 1) % images.length;
                            navigateLightbox(currentIndex, images)
                        })
                );
            // ç›‘å¬ ESC é”®
            $(document).on('keydown.lightbox', (e) => {
                if (e.key === 'Escape') {
                    closeLightbox();
                }
            });
            // æ”¯æŒç‚¹å‡»é®ç½©å±‚å…³é—­
            $lightbox.on('click', (e) => {
                if (e.target === $lightbox[0]) {
                    closeLightbox();
                }
            });

            $('body').append($lightbox);
        }
        // å…³é—­å¤§å›¾é¢„è§ˆ
        function closeLightbox() {
            $('.lightbox').remove();
            $(document).off('keydown.lightbox'); // ç§»é™¤äº‹ä»¶ç›‘å¬
        }

        function navigateLightbox(index, images) {
            let newUrl = images[index];

            $('.lightbox-image')
                .attr('src', newUrl)
                .css('opacity', 0)
                .on('load', function() {
                    $(this).css('opacity', 1);
                });
        }

        function searchSuccessFunc(baseParseResp){
            function modifyActiveTab($this){
                $header.find('.result-tab-button').removeClass('active')
                $this.addClass('active')
            }

            let $searchResultContainer = $mainContent.find('.search-result-container')
            $searchResultContainer.empty()
            $searchResultContainer.html(`
                <div class="search-result-header">
                </div>
                <div class="search-result-body">
                </div>
            `)
            let $header = $searchResultContainer.find('.search-result-header')
            let $body = $searchResultContainer.find('.search-result-body')
            $header.append(
                $('<div>')
                    .addClass('result-tab-button')
                    .text('metaä¿¡æ¯').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseParseMeta(baseParseResp, $body)
                }),
                $('<div>')
                    .addClass('result-tab-button')
                    .text('æŠ“å–ç»“æœ').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseParseCrawl(baseParseResp, $body)
                }),
                $('<div>')
                    .addClass('result-tab-button')
                    .text('é˜…è¯»å™¨ç½‘é¡µ').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseReadableHtml(baseParseResp, $body)
                }),
                $('<div>')
                    .addClass('result-tab-button')
                    .text('text-parseæ ‡ç­¾').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseTextParse(baseParseResp, $body)
                }),
                $('<div>')
                    .addClass('result-tab-button')
                    .text('è§£æå›¾ç‰‡').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseImages(baseParseResp, $body)
                }),
                $('<div>')
                    .addClass('result-tab-button')
                    .text('è§£ææ–‡æœ¬').on('click', function (){
                        // å¦‚æœå½“å‰å·²ç»æœ‰activeï¼Œä¸æ“ä½œ
                        if ($(this).hasClass('active')) {
                            return
                        }
                        modifyActiveTab($(this))
                        showBaseParseTextContent(baseParseResp, $body)
                }),
            )
            // ç‚¹å‡»ç¬¬ä¸€ä¸ªtab
            $header.find('.result-tab-button').first().click()
        }

        function doSearchByEventMsg(url, raw_html){
            showLoadingStatus($loadingContainer)
            axios.post('/base-parse', {
                'url': url,
                'html': raw_html,
                'entry_type': 7,
                'entry_id': '123',
                'with_raw_html': true,
                'rule_stage_group': 0,
                'skip_cache': true,
                'save_crawl_html': true,
            }).then(response => {
                let data = response.data
                if (data.code != 0) {
                    showToast("è§£æå¤±è´¥ï¼š" + data.msg)
                    return
                }
                let item = BuildHistory(
                    data.url,
                    data.title,
                    data.author,
                    data.pub_time,
                    data.worthless,
                )
                PushHistoryList(item)
                initHistoryList()
                searchSuccessFunc(data)
            }).catch(error => {
                console.error('Error create data:', error);
            }).finally(()=>{
                hideLoadingStatus($loadingContainer)
            })
        }
        function doSearchByInput(){
            let input = $mainContent.find('.search-input').val()
            let ruleStageGroup = parseInt($mainContent.find('.rule-selector').val())
            if (!input) {
                return
            }
            showLoadingStatus($loadingContainer)
            axios.post('/base-parse', {
                'url': input,
                'entry_type': 7,
                'entry_id': '123',
                'with_raw_html': true,
                'rule_stage_group': ruleStageGroup,
                'skip_cache': true,
                'save_crawl_html': true,
            }).then(response => {
                let data = response.data
                if (data.code != 0) {
                    showToast("è§£æå¤±è´¥ï¼š" + data.msg)
                    return
                }
                let item = BuildHistory(
                    data.url,
                    data.title,
                    data.author,
                    data.pub_time,
                    data.worthless,
                )
                PushHistoryList(item)
                initHistoryList()
                searchSuccessFunc(data)
            }).catch(error => {
                console.error('Error create data:', error);
            }).finally(()=>{
                hideLoadingStatus($loadingContainer)
            })
        }

        function initSearchEvent(){
            let $input = $mainContent.find('.search-input')
            let $searchButton = $mainContent.find('.search-button')
            // let $searchResultContainer = $mainContent.find('.search-result-container')

            $searchButton.on('click', function() {
                doSearchByInput()
            })

            $input.on('keydown', function(event) {
                if (event.key === 'Enter') {
                    doSearchByInput()
                }
            })

        }

        function main(){
            initHistoryList()
            initSearchEvent()
            window.addEventListener('message', function(event) {
                console.log('Received message from iframe:', event.data);
                let eventData = event.data
                let url = eventData.url
                let rawHtml = eventData.raw_html
                if (url && rawHtml) {
                    $mainContent.find('.search-input').val(url)
                    doSearchByEventMsg(url, rawHtml)
                }
            })
        }

        main()

    })
</script>
</body>
</html>
