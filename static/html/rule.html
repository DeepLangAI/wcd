<!DOCTYPE html>
<html>
    <head>
        <title> wcd站点规则库 </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />

        <script src="/public/js/jquery-3.6.0.min.js"></script>
        <script src="/public/js/axios.min.js"></script>
        <script src="/public/js/echarts.min.js"></script>

        <script src="/public/js/sidebar.js"></script>

        <link rel="stylesheet" href="/public/css/common.css">
        <link rel="stylesheet" href="/public/css/modal.css">
        <link rel="stylesheet" href="/public/css/sidebar.css">
    </head>
<body>
    <div id="app"/>

<script>
    let RuleStageEnum = {
        Testing: 0,
        Production: 1,
    }
    let RuleKeyToRead = {
        'name': '站点',
        'bodies': '正文',
        'noises': '噪声',
        'author': '作者',
        'title': '标题',
        'pub_time': '发布时间',
        'reserved_nodes': '保留节点',
        'create_time': '创建于',
        'update_time': '修改于',
        'no_semantic_denoise': '仅规则去噪',
        'need_browser_crawl': '浏览器抓取',
        'body_use_rule_only': '正文仅用站点规则',
    }


    function createLoadingContainer(){
        let loadingContainer = $('<div>')
            .addClass('loading-container')
            .addClass('hide')
            .append(
                $('<div>').addClass('loading-spinner')
            )
        return loadingContainer
    }
    // 显示加载状态
    function showLoadingStatus(loadingContainer) {
        loadingContainer.removeClass('hide');
    }

    // 隐藏加载状态
    function hideLoadingStatus(loadingContainer) {
        loadingContainer.addClass('hide');
    }
    /**
     * 判断是否可以跳过某个值
     * @param {*} value - 需要检查的值
     * @returns {boolean} - 如果值为空、空数组、空字符串或空对象，返回 true；否则返回 false
     */
    function shouldSkipValue(value) {
        // 检查是否为假值（null, undefined, 0, false, NaN 等）
        if (value == null || value == undefined || value == NaN){
        // if (!value) {
            return true;
        }

        // 检查是否为空数组
        if (Array.isArray(value) && value.length === 0) {
            return true;
        }

        // 检查是否为空字符串
        if (typeof value === "string" && value.trim() === "") {
            return true;
        }

        // 检查是否为空对象
        if (typeof value === "object" && !Array.isArray(value) && Object.keys(value).length === 0) {
            return true;
        }
        // 检查是否为bool false
        if (typeof value === "boolean" && value === false) {
            return true;
        }

        // 其他情况不跳过
        return false;
    }

    /**
     * 创建下拉菜单
     * @param {jQuery} $container - 下拉菜单的父容器
     * @param {Array<{text: string, onClick: Function}>} options - 菜单项配置
     */
    function createDropdownMenu($container, options) {
        // console.log(options)
        // 创建下拉菜单容器
        let $dropdownContainer = $('<div>').addClass('dropdown-container');
        let $dropdownButton = $('<button>').addClass('dropdown-button').html('&#8942;'); // 三竖点图标
        let $dropdownMenu = $('<div>').addClass('dropdown-menu');

        // 添加菜单项
        options.forEach(option => {
            // console.log(option)
            let $menuItem = $('<div>').addClass('dropdown-item').text(option.text);
            $menuItem.on('click', option.onClick); // 绑定点击事件
            $dropdownMenu.append($menuItem);
        });

        // 将按钮和菜单添加到容器中
        $dropdownContainer.append($dropdownButton, $dropdownMenu);
        $container.append($dropdownContainer);
        // console.log('options added', options)

        // 点击按钮显示/隐藏下拉菜单
        $dropdownButton.on('click', function (e) {
            e.stopPropagation(); // 阻止事件冒泡
            $dropdownMenu.toggleClass('active');
        });

        // 点击页面其他区域隐藏下拉菜单
        $(document).on('click', function () {
            $dropdownMenu.removeClass('active');
        });
        return $container
    }

    function createRuleHeader(ruleMeta, $ruleContainer, refreshFunc){
        let host = ruleMeta['host']
        let $ruleContainerHeader = $('<div>').addClass('header')

        // 创建下拉菜单容器
        let $dropdownContainer = $('<div>').addClass('dropdown-container');
        let $dropdownButton = $('<button>').addClass('dropdown-button').html('&#8942;'); // 三竖点图标
        let $dropdownMenu = $('<div>').addClass('dropdown-menu');

        let options = []
        if (ruleMeta['isProd']){
            options.push(
                {
                    text: '修改',
                    onClick: function () {
                        // alert('修改操作');
                        let success = callProdToTestingApi(host, refreshFunc)
                        // if (success){
                        //     refreshFunc()
                        // }
                    },
                },
                // {
                //     text: '删除',
                //     onClick: function () {
                //         alert('删除操作');
                //     },
                // },
            )
        } else {
            options.push(
                {
                    text: '修改',
                    onClick: function () {
                        // alert('修改操作');
                        createRuleEditModal($ruleContainer)
                    },
                },
                {
                    text: '发布',
                    onClick: function () {
                        // alert('发布操作');
                        let success = publishTestingRule($ruleContainer, refreshFunc)
                        // if (success){
                        //     // 删除$ruleContainer
                        //     // $ruleContainer.remove()
                        //     refreshFunc()
                        // }
                    },
                },
                {
                    text: '删除',
                    onClick: function () {
                        callDeleteRuleApi(host, RuleStageEnum.Testing, refreshFunc)
                        // alert('删除操作');
                    },
                },
            )
        }
        // 添加菜单项
        options.forEach(option => {
            // console.log(option)
            let $menuItem = $('<div>').addClass('dropdown-item').text(option.text);
            $menuItem.on('click', option.onClick); // 绑定点击事件
            $dropdownMenu.append($menuItem);
        });

        // 将按钮和菜单添加到容器中
        $dropdownContainer.append($dropdownButton, $dropdownMenu);
        $ruleContainerHeader.append($dropdownContainer);
        // console.log('options added', options)

        // 点击按钮显示/隐藏下拉菜单
        $dropdownButton.on('click', function (e) {
            e.stopPropagation(); // 阻止事件冒泡
            $dropdownMenu.toggleClass('active');
        });

        // 点击页面其他区域隐藏下拉菜单
        $(document).on('click', function () {
            $dropdownMenu.removeClass('active');
        });

        return $ruleContainerHeader
    }

    function callCreateRuleApi(ruleData, successFunc){
        // showLoadingStatus($loadingContainer)
        let success = true
        axios.post('/api/v1/site_rule/testing/new', ruleData).then(response => {
            console.log(response.data)
            if (response.data.code != 0){
                success = false
            }
            successFunc()
        }).catch(error => {
            console.error('Error create data:', error);
            success = false
        }).finally(()=>{
            // hideLoadingStatus($loadingContainer)
        })
        return success
    }
    function callUpdateRuleApi(ruleData){
        // showLoadingStatus($loadingContainer)
        let success = true
        axios.post('/api/v1/site_rule/testing/update', ruleData).then(response => {
            console.log(response.data)
            if (response.data.code != 0){
                success = false
            }
        }).catch(error => {
            console.error('Error updating data:', error);
            success = false
        }).finally(()=>{
            // hideLoadingStatus($loadingContainer)
        })
        return success
    }

    function callProdToTestingApi(host, successFunc){
        // showLoadingStatus($loadingContainer)
        let success = true
        axios.post('/api/v1/site_rule/prod/to_test', {
            'host': host,
        }).then(response => {
            console.log(response.data)
            if (response.data.code != 0){
                success = false
            }
            successFunc()
        }).catch(error => {
            console.error('Error updating data:', error);
            success = false
        }).finally(()=>{
            // hideLoadingStatus($loadingContainer)
        })
        return success
    }
    function callDeleteRuleApi(host, stage, successFunc){
        // showLoadingStatus($loadingContainer)
        let success = true
        axios.post('/api/v1/site_rule/delete', {
            'host': host,
            'stage': stage,
        }).then(response => {
            console.log(response.data)
            if (response.data.code != 0){
                success = false
            }
            successFunc()
        }).catch(error => {
            console.error('Error updating data:', error);
            success = false
        }).finally(()=>{
            // hideLoadingStatus($loadingContainer)
        })
        return success
    }
    function publishTestingRule($ruleContainer, successFunc) {
        let host = $ruleContainer.find('.host').text()
        let success = true
        axios.post('/api/v1/site_rule/testing/publish',
            {host: [host]}
        ).then(response => {
            console.log(response.data)
            if (response.data.code != 0){
                success = false
            }
            successFunc()

        }).catch(error => {
            console.error('Error publishing data:', error);
        }).finally(()=>{

        })
        return success

    }

    function createRuleCreateModal($ruleContainer, refreshFunc) {
        // 创建弹窗
        let $modal = $(`
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>新建规则</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="editContent"></div>
                </div>
                <div class="modal-footer">
                    <button id="confirmButton" class="modal-button confirm">确认</button>
                    <button id="cancelButton" class="modal-button cancel">取消</button>
                </div>
            </div>
        </div>
    `);

        let $editContent = $modal.find('#editContent');
        let $confirmButton = $modal.find('#confirmButton');
        let $cancelButton = $modal.find('#cancelButton');

        // 提取所有键值对到 keyValues 字典
        let keyValues = {
            'host': {
                'type': 'string',
                'value': '',
            },
            'name': {
                'type': 'string',
                'value': '',
            },
        };

        // 遍历 keyValues，填充弹窗内容
        for (let [key, data] of Object.entries(keyValues)) {
            let $editField = $('<div>')
                .addClass('edit-field')
                .attr('data-key', key);
            $editField.append($('<label>').text(RuleKeyToRead[key] || key));

            if (data.type === 'string') {
                // 字符串值：显示输入框
                $editField.append(
                    $('<input>')
                        .attr('type', 'text')
                        .val(data.value)
                        .addClass('edit-input')
                );
            } else if (data.type === 'list') {
                // 列表值：显示可编辑列表
                let $listContainer = $('<div>').addClass('edit-list-container');
                data.value.forEach(itemText => {
                    let $listItem = $('<div>').addClass('edit-list-item');
                    $listItem.append(
                        $('<input>')
                            .attr('type', 'text')
                            .val(itemText)
                            .addClass('edit-input')
                    );
                    $listItem.append(
                        $('<button>')
                            .text('删除')
                            .addClass('delete-item-button')
                            .on('click', function () {
                                $listItem.remove(); // 删除当前项
                            })
                    );
                    $listContainer.append($listItem);
                });

                // 添加「新增」按钮
                $listContainer.append(
                    $('<button>')
                        .text('新增')
                        .addClass('add-item-button')
                        .on('click', function () {
                            $listContainer.append(
                                $('<div>').addClass('edit-list-item').append(
                                    $('<input>')
                                        .attr('type', 'text')
                                        .val('')
                                        .addClass('edit-input'),
                                    $('<button>')
                                        .text('删除')
                                        .addClass('delete-item-button')
                                        .on('click', function () {
                                            $(this).parent().remove(); // 删除当前项
                                        })
                                )
                            );
                        })
                );

                $editField.append($listContainer);
            }

            $editContent.append($editField);
        }

        // 显示弹窗
        $modal.css('display', 'flex');

        // 确认按钮点击事件
        $confirmButton.off('click').on('click', function () {
            // 清空 ruleContainer 的 body
            // $ruleContainer.find('.body').empty();

            // 遍历弹窗中的编辑字段，重新填充 ruleContainer
            let updateData = {
                // 'host': $ruleContainer.find('.host').text()
            }
            $editContent.find('.edit-field').each(function () {
                let $editField = $(this);
                let key = $editField.attr('data-key'); // 获取字段名
                let keyRead = $editField.find('label').text(); // 获取字段名
                let $editInput = $editField.find('.edit-input');
                let $editListContainer = $editField.find('.edit-list-container');

                // 创建新的 .item
                let $newItem = $('<div>').addClass('item');
                let $newKey = $('<div>')
                    .attr('data-key', key)
                    .addClass('key')
                    .text(keyRead)
                let $newValue = $('<div>').addClass('value');

                if ($editInput.length > 0 && $editListContainer.length === 0) {
                    // 字符串值
                    let newValue = $editInput.val();
                    if (shouldSkipValue(newValue)){
                        return
                    }
                    $newValue.text(newValue).addClass('string-value');
                    updateData[key] = newValue
                } else if ($editListContainer.length > 0) {
                    // 列表值
                    let newValue = [];
                    $editListContainer.find('.edit-list-item').each(function () {
                        let val = $(this).find('.edit-input').val();
                        if (shouldSkipValue(val)){
                            return
                        }
                        newValue.push(val);
                    });
                    if (shouldSkipValue(newValue)){
                        return
                    }
                    updateData[key] = newValue

                    let $listContainer = $('<div>').addClass('list-container');
                    newValue.forEach(item => {
                        $listContainer.append(
                            $('<div>').addClass('list-item').text(item)
                        );
                    });
                    $newValue.append($listContainer);
                }

                // 将新的 .item 添加到 body 中
                $newItem.append($newKey, $newValue);
                // $ruleContainer.find('.body').append($newItem);
            });
            let success = callCreateRuleApi(updateData, refreshFunc)
            if (success){
                // 关闭弹窗
                $modal.css('display', 'none');
            }
        });

        // 取消按钮点击事件
        $cancelButton.off('click').on('click', function () {
            $modal.css('display', 'none');
        });

        // 关闭按钮点击事件
        $modal.find('.close').off('click').on('click', function () {
            $modal.css('display', 'none');
        });

        // 将弹窗添加到页面
        $('#ruleModal').empty().append($modal);
    }

    function createRuleEditModal($ruleContainer) {
        // 创建弹窗
        let $modal = $(`
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>修改规则</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="editContent"></div>
                </div>
                <div class="modal-footer">
                    <button id="confirmButton" class="modal-button confirm">确认</button>
                    <button id="cancelButton" class="modal-button cancel">取消</button>
                </div>
            </div>
        </div>
    `);

        let $editContent = $modal.find('#editContent');
        let $confirmButton = $modal.find('#confirmButton');
        let $cancelButton = $modal.find('#cancelButton');

        // 提取所有键值对到 keyValues 字典
        let keyValues = {};
        let legalKeys = [
            'name',
            'bodies',
            'noises',
            'author',
            'title',
            'pub_time',
            'reserved_nodes',
            'no_semantic_denoise',
            'need_browser_crawl',
            'body_use_rule_only',
        ];
        $ruleContainer.find('.item').each(function () {
            let $item = $(this);
            let key = $item.find('.key').attr('data-key');
            if (!legalKeys.includes(key)) {
                return
            }
            // let keyRead = $item.find('.key').text();
            let $value = $item.find('.value');

            if ($value.hasClass('string-value')) {
                // 字符串值
                keyValues[key] = {
                    type: 'string',
                    value: $value.text(),
                };
            } else if ($value.hasClass('bool-value')){
                // 布尔值
                keyValues[key] = {
                    type: 'bool',
                    value: $value.hasClass('true'),
                };
            } else if ($value.find('.list-container').length > 0) {
                // 列表值
                keyValues[key] = {
                    type: 'list',
                    value: $value.find('.list-item').map(function () {
                        return $(this).text();
                    }).get(),
                };
            }
        });
        if (!('name' in keyValues)) {
            keyValues['name'] = {
                type: 'string',
                value: '',
            }
        }
        if (!('bodies' in keyValues)) {
            keyValues['bodies'] = {
                type: 'list',
                value: [],
            }
        }
        if (!('noises' in keyValues)) {
            keyValues['noises'] = {
                type: 'list',
                value: [],
            }
        }
        if (!('author' in keyValues)) {
            keyValues['author'] = {
                type: 'string',
                value: '',
            }
        }
        if (!('title' in keyValues)) {
            keyValues['title'] = {
                type: 'string',
                value: '',
            }
        }
        if (!('pub_time' in keyValues)) {
            keyValues['pub_time'] = {
                type: 'string',
                value: '',
            }
        }
        if (!('reserved_nodes' in keyValues)) {
            keyValues['reserved_nodes'] = {
                type: 'list',
                value: [],
            }
        }
        if (!('no_semantic_denoise' in keyValues)) {
            keyValues['no_semantic_denoise'] = {
                type: 'bool',
                value: false,
            }
        }
        if (!('need_browser_crawl' in keyValues)) {
            keyValues['need_browser_crawl'] = {
                type: 'bool',
                value: false,
            }
        }
        if (!('body_use_rule_only' in keyValues)) {
            keyValues['body_use_rule_only'] = {
                type: 'bool',
                value: false,
            }
        }
        // console.log(keyValues)

        // 遍历 keyValues，填充弹窗内容
        for (let [key, data] of Object.entries(keyValues)) {
            let $editField = $('<div>')
                .addClass('edit-field')
                .attr('data-key', key);
            $editField.append($('<label>').text(RuleKeyToRead[key] || key));

            if (data.type === 'string') {
                // 字符串值：显示输入框
                $editField.append(
                    $('<input>')
                        .attr('type', 'text')
                        .val(data.value)
                        .addClass('edit-input')
                );
            } else if (data.type === 'bool'){
                // 布尔值：显示复选框
                $editField.append(
                    $('<input>')
                        .attr('type', 'checkbox')
                        .prop('checked', data.value)
                        .addClass('bool-input')
                );
                $editField.addClass('bool-edit-field');
            } else if (data.type === 'list') {
                // 列表值：显示可编辑列表
                let $listContainer = $('<div>').addClass('edit-list-container');
                data.value.forEach(itemText => {
                    let $listItem = $('<div>').addClass('edit-list-item');
                    $listItem.append(
                        $('<input>')
                            .attr('type', 'text')
                            .val(itemText)
                            .addClass('edit-input')
                    );
                    $listItem.append(
                        $('<button>')
                            .text('删除')
                            .addClass('delete-item-button')
                            .on('click', function () {
                                $listItem.remove(); // 删除当前项
                            })
                    );
                    $listContainer.append($listItem);
                });

                // 添加「新增」按钮
                $listContainer.append(
                    $('<button>')
                        .text('新增')
                        .addClass('add-item-button')
                        .on('click', function () {
                            $listContainer.append(
                                $('<div>').addClass('edit-list-item').append(
                                    $('<input>')
                                        .attr('type', 'text')
                                        .val('')
                                        .addClass('edit-input'),
                                    $('<button>')
                                        .text('删除')
                                        .addClass('delete-item-button')
                                        .on('click', function () {
                                            $(this).parent().remove(); // 删除当前项
                                        })
                                )
                            );
                        })
                );

                $editField.append($listContainer);
            }

            $editContent.append($editField);
        }

        // 显示弹窗
        $modal.css('display', 'flex');

        // 确认按钮点击事件
        $confirmButton.off('click').on('click', function () {
            // 清空 ruleContainer 的 body
            $ruleContainer.find('.body').empty();

            // 遍历弹窗中的编辑字段，重新填充 ruleContainer
            let updateData = {
                'host': $ruleContainer.find('.host').text()
            }
            $editContent.find('.edit-field').each(function () {
                let $editField = $(this);
                let key = $editField.attr('data-key'); // 获取字段名
                let keyRead = $editField.find('label').text(); // 获取字段名
                let $editInput = $editField.find('.edit-input');
                let $boolInput = $editField.find('.bool-input');
                let $editListContainer = $editField.find('.edit-list-container');

                // 创建新的 .item
                let $newItem = $('<div>').addClass('item');
                let $newKey = $('<div>')
                    .attr('data-key', key)
                    .addClass('key')
                    .text(keyRead)
                let $newValue = $('<div>').addClass('value');
                if ($boolInput.length > 0 && $editListContainer.length === 0){
                    // bool值
                    let newValue = $boolInput.prop('checked');
                    if (shouldSkipValue(newValue)){
                        return
                    }
                    $newValue
                        .addClass('bool-value')
                        .addClass(newValue ? 'true' : 'false');
                    updateData[key] = newValue
                } else if ($editInput.length > 0 && $editListContainer.length === 0) {
                    // 字符串值
                    let newValue = $editInput.val();
                    if (shouldSkipValue(newValue)){
                        return
                    }
                    $newValue.text(newValue).addClass('string-value');
                    updateData[key] = newValue
                } else if ($editListContainer.length > 0) {
                    // 列表值
                    let newValue = [];
                    $editListContainer.find('.edit-list-item').each(function () {
                        let val = $(this).find('.edit-input').val();
                        if (shouldSkipValue(val)){
                            return
                        }
                        newValue.push(val);
                    });
                    if (shouldSkipValue(newValue)){
                        return
                    }
                    updateData[key] = newValue

                    let $listContainer = $('<div>').addClass('list-container');
                    newValue.forEach(item => {
                        $listContainer.append(
                            $('<div>').addClass('list-item').text(item)
                        );
                    });
                    $newValue.append($listContainer);
                }

                // 将新的 .item 添加到 body 中
                $newItem.append($newKey, $newValue);
                $ruleContainer.find('.body').append($newItem);
            });
            let success = callUpdateRuleApi(updateData)
            if (success){
                // 关闭弹窗
                $modal.css('display', 'none');
            }
        });

        // 取消按钮点击事件
        $cancelButton.off('click').on('click', function () {
            $modal.css('display', 'none');
        });

        // 关闭按钮点击事件
        $modal.find('.close').off('click').on('click', function () {
            $modal.css('display', 'none');
        });

        // 将弹窗添加到页面
        $('#ruleModal').empty().append($modal);
    }

    function exportRules(){
        axios.get('/api/v1/site_rule/export', {
            responseType: 'blob' // 设置响应类型为 blob
        })
            .then(response => {
                // 从 Content-Disposition 中提取文件名
                const contentDisposition = response.headers['content-disposition'];
                let filename = 'exported_file'; // 默认文件名

                if (contentDisposition && contentDisposition.indexOf('attachment') !== -1) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, ''); // 去除引号
                    }
                }

                // 创建一个 Blob 对象
                const blob = new Blob([response.data], { type: response.headers['content-type'] });

                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;

                // 设置文件名
                link.setAttribute('download', filename);

                // 触发下载
                document.body.appendChild(link);
                link.click();

                // 清理
                link.parentNode.removeChild(link);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error downloading the file:', error);
            });
    }

    $(document).ready(function () {
        let $loadingContainer = createLoadingContainer()

        let $app = $('#app');
        let $modal = $('<div id="ruleModal">');
        let $sidebar = generateNav('站点规则')
        let $mainContent = $(`<div style="display: flex; flex-direction: row">
            <div id="sidebar"> </div>
            <div id="app-content"> </div>
        </div>`)
        let $appContent = $mainContent.find('#app-content')
        $mainContent.find('#sidebar').append($sidebar)
        $app.append($mainContent, $loadingContainer, $modal)

        function createListPage($parent, query) {
            function getMetaInfo(rule) {
                let isProd = false
                let meta = {}
                for (let key in rule) {
                    let value = rule[key]
                    if (key == 'stage') {
                        isProd = value == RuleStageEnum.Production
                        meta['isProd'] = isProd
                    } else if (key == 'host'){
                        meta['host'] = value
                    }
                }
                return meta
            }

            showLoadingStatus($loadingContainer)

            axios.post('/api/v1/site_rule/list', {
                    "query": query,
                    "order_by": "-update_time",
                },
            ).then(response => {
                let rules = response.data.data;
                let dataIndex = 0
                let hostSeen = {}
                for (let i = 0; i < rules.length; i++){
                    let rule = rules[i]
                    let $doubleColumnContainer = $('<div>').addClass('double-column-rule')
                    let $ruleContainer = $('<div>').addClass('rule-container')
                    let $ruleContainerBody = $('<div>').addClass('body')

                    let ruleMeta = getMetaInfo(rule)
                    let $ruleContainerHeader = createRuleHeader(ruleMeta, $ruleContainer, function (){
                        $parent.empty()
                        createListPage($parent, query)
                    })
                    $doubleColumnContainer.append($ruleContainer)
                    $ruleContainer.append($ruleContainerHeader, $ruleContainerBody)

                    for (let key in rule){
                        let value = rule[key]
                        if (shouldSkipValue(value)){
                            continue
                        }
                        if (key == 'host'){
                            if (!hostSeen[value]){
                                dataIndex += 1
                                hostSeen[value] = true
                            }
                            $doubleColumnContainer.attr('host', value)
                            // 如果$app下已有相同host的元素，则将$ruleContainer插入到该元素内作为子元素
                            let $existingHostContainer = $parent.find(`[host="${value}"]`);
                            if ($existingHostContainer.length > 0) {
                                $doubleColumnContainer = $existingHostContainer
                                $doubleColumnContainer.append($ruleContainer);
                            }
                            // $ruleContainerHeader.text(value)
                            let $host = $('<div>').addClass('host').text(value)
                            // 添加到 $ruleContainerHeader中的第一个子元素
                            $ruleContainerHeader.prepend($host)
                            $ruleContainerHeader.attr('data-index', dataIndex)
                            continue
                        }
                        if (key == 'stage'){
                            if (value == RuleStageEnum.Testing){
                                $ruleContainerHeader.addClass('testing')
                            }
                            continue
                        }

                        let $item = $('<div>').addClass('item')
                        // 如果value是字符串
                        let $key = $('<div>')
                            .addClass('key')
                            .text(RuleKeyToRead[key] || key)
                            .attr('data-key', key)
                        let $value = $('<div>').addClass('value')
                        if (typeof value === 'boolean') {
                            $value
                                .addClass('bool-value')
                                .addClass(value ? 'true' : 'false')
                        } else if (typeof value === 'string'){
                            $value.addClass('string-value').text(value)
                        } else if (Array.isArray(value)) {
                            // 如果value是列表
                            let $listContainer = $('<div>').addClass('list-container')
                            for (let j = 0; j < value.length; j++){
                                let item = value[j]
                                let $listItem = $('<div>').addClass('list-item').text(item)
                                $listContainer.append($listItem)
                            }
                            $value.append($listContainer)
                        } else if (typeof value === 'object') {
                        }
                        $item.append($key)
                        $item.append($value)
                        $ruleContainerBody.append($item)
                    }
                    $parent.append($doubleColumnContainer)
                }

            }).catch(error => {
                console.error('Error fetching data:', error);

            }).finally(()=>{
                hideLoadingStatus($loadingContainer)
            })
        }

        function createRuleMainPage(){
            let $ruleApp = $('<div>').addClass('rule-app');
            // 添加搜索框
            let $searchInput = $('<input>')
                .attr('type', 'text')
                .attr('placeholder', '搜索')
                .addClass('search-input')
            // 添加搜索按钮
            let $searchButton = $('<button>')
                .text('搜索')
                .addClass('search-button')
            // 添加新建按钮
            let $newButton = $('<button>')
                .text('新建')
                .addClass('new-button');

            // 添加导出按钮
            let $exportButton = $('<button>')
                .text('导出')
                .addClass('export-button');

            // 添加导入按钮
            let $importButton = $('<button>')
                .text('导入')
                .addClass('import-button');

            let $searchResultContainer = $('<div>').addClass('search-result-container')

            // 搜索按钮点击事件
            $searchButton.on('click', function () {
                let query = $searchInput.val().trim();
                $searchResultContainer.empty()
                createListPage($searchResultContainer, query);
            });

            // 搜索框回车键事件
            $searchInput.on('keypress', function (e) {
                if (e.key === 'Enter') {
                    let query = $searchInput.val().trim();
                    $searchResultContainer.empty()
                    createListPage($searchResultContainer, query);
                }
            });

            // 新建按钮点击事件
            $newButton.on('click', function () {
                createRuleCreateModal(null, function (){
                    let query = $searchInput.val().trim();
                    $searchResultContainer.empty()
                    createListPage($searchResultContainer, query);
                })
            });

            // 导出按钮点击事件
            $exportButton.on('click', function () {
                exportRules()
            })

            // 导入按钮点击事件
            $importButton.on('click', function () {
                // 创建隐藏的文件输入
                let $fileInput = $('<input type="file" accept=".json">');
                $fileInput.on('change', function (e) {
                    let file = e.target.files[0];
                    if (file) {
                        let formData = new FormData();
                        formData.append('file', file);
                        
                        // 发送POST请求
                        $.ajax({
                            url: '/api/v1/site_rule/import',
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function (response) {
                                if (response.code === 0) {
                                    alert('导入成功');
                                    // 刷新页面
                                    let query = $searchInput.val().trim();
                                    $searchResultContainer.empty();
                                    createListPage($searchResultContainer, query);
                                } else {
                                    alert('导入失败: ' + (response.msg || '未知错误'));
                                }
                            },
                            error: function (xhr, status, error) {
                                alert('导入失败: ' + error);
                            }
                        });
                    }
                });
                // 触发文件选择
                $fileInput.click();
            })

            // 添加搜索结果容器
            createListPage($searchResultContainer)
            let $searchArea = $('<div>').addClass('search-area')
            let $buttonContainer = $('<div>').addClass('button-container')
            $buttonContainer.append($searchButton, $newButton, $exportButton, $importButton)
            $searchArea.append($searchInput, $buttonContainer)

            $ruleApp.append($searchArea, $searchResultContainer)
            $appContent.append($ruleApp)

        }

        function main(){
            createRuleMainPage()
        }

        main()

    })
</script>
</body>
</html>
